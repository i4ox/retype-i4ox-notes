# Шпаргалка по базам данных

## Нормализация

**Нормализация** - процесс преобразования структуры БД для уменьшения избыточности данных и предотвращения аномалий обновления.
Она основана на математической теории реляционных баз данных.

### Первая нормальная форма
- У таблицы должна быть первичная ключевая колонка(ID,UUID).
- Все строки таблицы уникальны.
- Все значения атрибутов(столбцов) должны быть атомарными(неделимыми).

До 1NF:

|*Фирма*|Модели|
|-----|------|
|BMW|M5,X5M,M1|
|Nissan|GT-R|

После 1NF:

|*Фирма*|Модели|
|-----|------|
|BMW|M5|
|BMW|X5M|
|BMW|M1|
|Nissan|GT-R|

 
### Вторая нормальная форма

- Таблица находится в 1НФ.
- Все неключевые атрибуты должны зависить от всего составного ключа, а не от его части.

До 2NF:

|*Модель*|*Фирма*|Цена|Скидка|
|------|-----|----|------|
|M5|BMW|5500000|5%|
|X5M|BMW|6000000|5%|
|M1|BMW|2500000|5%|
|GT-R|Nissan|5000000|10%|

После 2NF: ***Цена зависит от модели и фирмы, а скидка зависит только от фирмы***

|*Модель*|*Фирма*|Цена|
|------|-----|----|
|M5|BMW|5500000|
|X5M|BMW|6000000|
|M1|BMW|2500000|
|GT-R|Nissan|5000000|

|*Фирма*|Скидка|
|-----|------|
|BMW|5%|
|BMW|5%|
|BMW|5%|
|Nissan|10%|

### Третья нормальная форма

- Таблица находится в 2НФ.
- Все неключевые атрибуты должны зависеть только от первичного ключа.

До 3NF:

|*Модель*|Магазин|Телефон|
|------|-------|-------|
|BMW|Риал-авто|87-33-98|
|Audi|Риал-авто|87-33-98|
|Nissan|Некст-Авто|94-54-12|

После 3NF: ***Телефон не зависит от первичного ключа, а от магазина.***

|*Модель*|Магазин|
|------|-------|
|BMW|Риал-авто|
|Audi|Риал-авто|
|Nissan|Некст-Авто|

|*Магазин*|Телефон|
|-------|-------|
|Риал-авто|87-33-98|
|Риал-авто|87-33-98|
|Некст-Авто|94-54-12|

### Нормальная форма Бойса-Кодда или Частная форма 3NF

- Таблица в 3NF.
- Все неключевые атрибуты не должны зависеть от других неключевых.

До BCNF:

|*Номер стоянки*|Время начала|Время окончания|Тариф|
|---------------|------------|---------------|-----|
|*Номер стоянки*|Время начала|Время окончания|Тариф|
|1|09:30|10:30|Бережливый|
|1|11:00|12:00|Бережливый|
|1|14:00|15:30|Cтандарт|
|2|10:00|12:00|Премиум-В|
|2|12:00|14:00|Премиум-В|
|2|15:00|18:00|Премиум-А|

После BCNF: ***Номер стоянки зависит от тарифа, а также время окончания зависит от времени начала и тарифа***

|*Тариф*|Номер стоянки|
|-------|-------------|
|Бережливый|1|
|Cтандарт|1|
|Премиум-В|2|
|Премиум-А|2|

|*Тариф*|*Время начала*|Время окончания|
|-------|--------------|---------------|
|Бережливый|09:30|10:30|
|Бережливый|11:00|12:00|
|Cтандарт|14:00|15:30|
|Премиум-В|10:00|12:00|
|Премиум-В|12:00|14:00|
|Премиум-А|15:00|18:00|

### Четвертая нормальная форма

- Таблица в BCNF:
- Все многозначные зависимости должны быть удалены. То есть атрибуты зависят от первичного ключа, но не от друг друга.

До 4NF:

|*ID*|Проект|Хобби|
|--|----------------|--------------|
|1|Сантехник|Радиотехника|
|1|КайзерДом|Гитара|
|2|FabioRoss|Футфол|
|3|КайзерДом|Хоккей|
|3|Доска Почета|Гитара|

После 4NF: ***Проект и хобби зависят от ID, но не от друг друга. Это многозначная зависимость***

|*ID*|Проект|
|--|----------------|
|1|Сантехник|
|1|КайзерДом|
|2|FabioRoss|
|3|КайзерДом|
|3|Доска Почета|

|*ID*|Хобби|
|--|--------------|
|1|Радиотехника|
|1|Гитара|
|2|Футфол|
|3|Хоккей|
|3|Гитара|

### Пятая нормальная форма

- Таблица в 4NF.
- Отсутствуют сложные зависимости между атрибутами.
- Правило, которое крайне трудно найти на практике в чистом виде.

До 5NF:

|Производитель|Продукт|Поставщик|
|-------------|-------|---------|
|A|Продукт1|X|
|A|Продукт2|X|
|B|Продукт1|X|
|B|Продукт2|Y|

После 5NF: ***Присутствует трехсторонняя зависимость***

|*Производитель*|Продукт|
|-------------|-------|
|A|Продукт1|
|A|Продукт2|
|B|Продукт1|
|B|Продукт2|

|*Продукт*|Поставщик|
|-------|---------|
|Продукт1|X|
|Продукт2|X|
|Продукт2|Y|

|*Производитель*|Поставщик|
|-------------|---------|
|A|X|
|B|X|
|B|Y|

### Шестая нормальная форма

Та форма когда отношение уже неможет быть декомпозирована без потерь.

## Диаграммы "сущность-связь" или ER-диаграммы

**ER-диаграммы** используются для визуализации структуры БД на этапе проектирования.

### Основные элементы ER-диаграммы

- *Сущность*: объекты, которые надо хранить в БД.
- *Атрибуты*: свойства сущностей.
- *Связи*: отношения между сущностями.

### Уровни ER-диаграммы

- *Концептуальный уровень*: отображает только основные сущности и связи.
- *Логический уровень*: добавляет атрибуты и детали связей
- *Физический уровень*: конкретизация хранения, включая ключи и индексы.

### Методы разработки ER-диаграмм

1. **Определение сущностей** - выявление объектов, о которых нужно хранить данные.
2. **Определение атрибутов** - свойства сущностей.
3. **Определение связей между сущностями** - устанавливается, как объекты взаимодействуют друг с другом.
4. **Создание диаграммы** - используются специальные символы для сущностей, атрибутов и связей.

### Средства разработки ER-диаграмм

1. *Ручное рисование*
2. *Специализированные инструменты*: Lucidchart,Draw.io,Microsoft Visio,MySQL Workbench.

### Ограничения

- *Кардинальность*: определяет количество записей, связанных друг с другом(1:1, 1:N, M:N).
- *Обящательность*: показывает, может ли существовать без определенной сущность.

## Структура языка SQL

**SQL** - тьюринго-полные язык программирования, нацеленный на создания запросов к БД.
Состоит из нескольких DSL(Domain Specific Language): DDL, DML, DQL, TCL, DCL.

### DDL - Data Definition Language

**DDL** - используется для определения структуры базы данных.

- `CREATE TABLE`
- `ALTER TABLE`
- `DROP TABLE`

### DML - Data Manipulation Language

**DML** - используется для управления данными.

- `INSERT INTO`
- `UPDATE`
- `DELETE`

### DQL - Data Query Language

**DQL** - используется для извлечения данных. Основная команда `SELECT`.

Пример:

```sql
SELECT name,age FROM students WHERE age > 18;
```

### TCL - Transaction Control Language

**TCL** - используется для управления транзакциями.

- `COMMIT` - подтверждение.
- `ROLLBACK` - откат изменений.
- `SAVEPOINT` - создание точки отката.

### DCL - Data Control Language

**DCL** - используется для управления правами доступа.

- `GRANT` - предоставление прав.
- `REVOKE` - отзык прав.

## Типы данных SQL

Типы данных определяют, какие значения можно хранить в колонке таблицы.

### Числовые

- `INT, SMALLINT, BIGINT` - целые числа разной разрядности.
- `DECIMAL(p,s), NUMERIC(p,s)` - числа с фиксированной точностью.
- `FLOAT,REAL` - числа с плавающей точкой.

### Строковые

- `CHAR(n)` - строка фиксированной длины.
- `VARCHAR(n)` - строка переменной длины.
- `TEXT` - текстовые данные большой длины.

### Дата и время

- `DATE` - только дата.
- `TIME` - только время.
- `TIMESTAMP` - дата и время.

### Булевы

- `BOOLEAN` - значения TRUE,FALSE

## Операторы SQL

### Структура SQL-операторов

Операторы SQL структурированы по их назначения: DDL, DML, DQL, TCL, DCL. Смотреть выше.

### Нотации SQL

1. *Стандартная нотация* - поддерживается всеми СУБД.
2. *Расширенная нотация* - поддерживается только конкретной СУБД.

### Форматы конструкций

DDL:

```sql
CREATE TABLE students (
    student_id INT PRIMARY KEY,
    name VARCHAR(100),
    age INT,
    enrollment_date DATE
);

ALTER TABLE students
ADD COLUMN address VARCHAR(255);

DROP TABLE students;
```

DML:

```sql
INSERT INTO students (student_id, name, age, enrollment_date)
VALUES (1, 'Иван Иванов', 20, '2023-09-01');

UPDATE students
SET age = 21
WHERE student_id = 1;

DELETE FROM students
WHERE student_id = 1;
```

DQL:

```sql
SELECT name, age
FROM students
WHERE age > 18;

SELECT name, age
FROM students
ORDER BY age DESC;

SELECT COUNT(*) AS total_students
FROM students;
```

TCL:

```sql
BEGIN TRANSACTION;

UPDATE students
SET age = 22
WHERE student_id = 1;

COMMIT; -- Изменения сохраняются
-------------------
BEGIN TRANSACTION;

UPDATE students
SET age = 22
WHERE student_id = 1;

ROLLBACK;  -- Все изменения отменяются
-------------------
BEGIN TRANSACTION;

UPDATE students
SET age = 22
WHERE student_id = 1;

SAVEPOINT save1;  -- Создаем точку отката

UPDATE students
SET age = 23
WHERE student_id = 1;

ROLLBACK TO SAVEPOINT save1;  -- Откатываем изменения до save1

COMMIT;
```

DCL:

```sql
GRANT SELECT, INSERT ON students TO user1;

REVOKE SELECT, INSERT ON students FROM user1;
```

## Основные объекты языка SQL

1. *Таблицы* - основные структуры для хранения данных.
  ```sql
  CREATE TABLE employees(
    id INT PRIMARY KEY,
    name VARCHAR(100),
    salary DECIMAL(10,2)
  );
  ```

2. *Представления* - Логические таблицы, основанные на результатах запросов, или виртуальные таблицы, содержимое которых определяется запросом.
  ```sql
  CREATE VIEW high_salary_employees AS
  SELECT name, salary FROM employees WHERE salary > 50000;
  ```
3. *Индексы* - структуры для ускорения поиска данных. Строки здесь расположены в определенном порядке, но вместо того, чтобы содержать информацию содержит лишь то, что необходимо, чтобы найти нужную информацию.
  ```sql
  CREATE INDEX idx_name ON employees(name);
  ```
4. *Хранимые процедуры и функции* - код, выполняемый на сервере для автоматизации операций.
  ```sql
  CREATE FUNCTION add_employee(name VARCHAR(100), salary DECIMAL(10,2))
  AS
  BEGIN
    INSERT INTO employees(name, salary) VALUES(name, salary);
  END;
  ```
5. *Триггеры* - код, который автоматически запускается при выполнении операций `INSERT`, `UPDATE` и `DELETE`.
