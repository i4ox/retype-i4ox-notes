# Полное руководство по сетям

**Сетевое администрирование** - ключевой навык любого системного администратора.

## Основы сетей

### Что такое IP-адрес?

**IP-адрес** - это уникальный идентификатор устройства в сети.

1. **IPv4** (32-битный, записывается в виде 4 чисел, разделенных точками): Пример: 192.168.1.1
2. **IPv6** (128-битный, записывается в 8 группах шестнадцатеричных чисел): Пример: 2001:db8::ff00:42:8329

### Что такое маска сети?

**Маска** определяет, какая часть IP-адреса относится к сети, а какая к хосту.

| Маска | CIDR | Кол-во адресов | Диапазон хостов |
|-------|------|----------------|-----------------|
| 255.0.0.0 | /8 | 16,777,214 | 10.0.0.1 - 10.255.255.254 |
| 255.255.0.0 | /16 | 65,534 | 192.168.0.1 - 192.168.255.254 |
| 255.255.255.0 | /24 | 254 | 192.168.1.1 - 192.168.1.254 |

!!!
Чем больше битов в маске, тем меньше адресов в сети.
!!!

### Подсети и CIDR

**CIDR(Classless Inter-Domain Routing)** - обозначение сети через `/ число_битов_маски`.

Пример:

- `192.168.1.0/24` -> сеть с 256 узлами(254 + 2 узла локального хоста)
- `192.168.1.0/30` -> сеть с 4 узлами(2 + 2 узла локального хоста)

Формула для расчета количества хостов: `2^(32 - число_битов_маски) - 2`.

### Как считать IP-адрем?

Пример: `192.168.88.45 /20`

1. Переводим в двоичный формат: `192.168.88.45 = 11000000.10101000.01011000.00101101`
2. Маска 32 - 20(сеть) = 12(хосты).
3. Обнуляем 12 битов. `11000000.10101000.01011000.00101101 = 11000000.10101000.01010000.00000000`
4. Переводим в десятичный формат: `11000000.10101000.01010000.00000000 = 192.168.80.0`
5. Заполняем все хост адреса единицами: `11000000.10101000.01011000.00101101 = 11000000.10101000.01011111.11111111`
6. Переводив в десятичный формат: `11000000.10101000.01011111.11111111 = 192.168.95.255`
7. Первый адрес = `192.168.80.1`
8. Последний адрес = `192.168.95.254`

### Типы IP-адресов и их назначение

**Приватные сети (RFC 1918)**:

- 10.0.0.0/8
- 172.16.0.0/12
- 192.168.0.0/16

**Публичный IP** - доступный для всех на сети.

**Локальные(Loopback) IP** - `127.0.0.1`.

### Модель OSI и TCP/IP

Сетевое взаимодействие строится на двух ключевых моделях:

**Модель OSI(7 уровней)**:

1. Физический - кабели, Wi-Fi, разъемы.
2. Канальный - MAC-адрема, VLAN, Ethernet.
3. Сетевой - IP-адреса, маршрутизация(IPv4, IPv6).
4. Транспортный - протоколы TCP, UDP.
5. Сеансовый - установление соединений (TLS, RPC).
6. Представительный - кодировки, шифрование.
7. Прикладной - HTTP, FTP, SSH, DNS.

**Модель TCP/IP(4 уровня)**:

1. Сетевой интерфейс(физика и MAC).
2. Интернет(IP, ICMP).
3. Транспортный(TCP, UDP).
4. Прикладный(HTTP, DNS, FTP, SSH).

!!!
На практике чаще используется модель TCP/IP, так как она проще и отражает реальную работу сетей.
!!!

### Протоколы связи

- **ICMP** (ping, traceroute) — проверка доступности.
- **ARP** — преобразование IP-адресов в MAC-адреса.
- **DHCP** — автоматическая раздача IP-адресов.
- **DNS** — перевод доменных имен в IP.
- **HTTP/HTTPS** — веб-протоколы.
- **SSH** — защищенное соединение.

### Сетевые устройства

- **Маршрутизатор (Router)** — передает трафик между сетями
- **Коммутатор (Switch)** — соединяет устройства в одной сети
- **Файрволл (Firewall)** — фильтрует трафик
- **Доступная точка (Access Point)** — раздает Wi-Fi
- **Прокси-сервер (Proxy)** — передает запросы пользователей

## Сетевое администрирование

### Проверка сетевых подключений

```bash
ping -c 5 google.com # Проверка сетевого подключения

traceroute google.com # Определение маршрута к серверу
tracert google.com # Аналог traceroute в Windows

dig google.com # Поиск DNS-записи для сервера
nslookup google.com # Аналог dig в Windows
```

### Конфигурация сетевых интерфейсов

```bash
ip a # Проверка IP-адресов и их назначение
ip addr add 192.168.1.1/24 dev eth0 # Добавление IP-адреса в интерфейс

ip route show # Проверка маршрутизации интерфейсов
ip route add 192.168.1.0/24 via 192.168.1.1 # Добавление маршрута
```

### Настройка DNS

Файл `/etc/resolv.conf` содержит настройки DNS-сервера, используемых системой.

Пример содержимого файла:

```ini
nameserver 8.8.8.8 # Google DNS
nameserver 1.1.1.1 # Cloudflare DNS
search example.com # Поиск доменов по имени
options timeout:2 # Время ожидания ответа от DNS-сервера
```

Основные параметры:

- `nameserver` - IP-адрес DNS-сервера(до 3-х серверов)
- `search` - домены по имени, которые будут использоваться для поиска DNS-записей
- `options` - настройки DNS-сервера

!!!
Файл может быть перезаписан сервисами, например, `systemd-resolved`, `dhclient` или `NetworkManager`.
!!!

Отключение автоматического обновления `resolv.conf`:

```bash
chattr +i /etc/resolv.conf # Отключить автоматическое обновление
```

### Управление сетевыми интерфейсами

Файл `/etc/network/interfaces` управляет статическими настройками сетевых интерфейсов(Debian, Ubuntu).

Пример содержимого файла:

```bash
auto eth0
iface eth0 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 1.1.1.1
```

Если надо автоматически получать IP:

```bash
auto eth0
iface eth0 inet dhcp
```

Применение настроек:

```bash
sudo systemctl restart networking
```

Для RHEL/CentOS используется файл `/etc/sysconfig/network-scripts/ifcfg-eth0`.

Пример содержимого файла:

```bash
DEVICE=eth0
BOOTPROTO=static
ONBOOT=yes
IPADDR=192.168.1.100
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=8.8.8.8
DNS2=1.1.1.1
```

Перезапуск сети:

```bash
sudo systemctl restart NetworkManager
```

### DHCP-сервер `dnsmasq`

**dnsmasq** - легковесный DNS/DHCP-сервер, который можно использовать для настройки локальной сети.

Установка:

```bash
sudo apt install dnsmasq # Debian/Ubuntu
sudo dnf install dnsmasq # RHEL/CentOS
```

Файл конфигурации `/etc/dnsmasq.conf`:

```ini
dhcp-range=192.168.1.100,192.168.1.200,12h # Вклюсение DHCP-сервера
dhcp-host=AA::BB::CC:DD:EE:FF,192.168.1.50,4h # Статический IP для устройства

server=8.8.8.8 # Первый DNS-сервер
server=1.1.1.1 # Второй DNS-сервер

cache-size=1000 # Кэш DNS-записей
```

Запуск и проверка работы:

```bash
sudo systemctl restart dnsmasq
sudo systemctl enable dnsmasq
sudo systemctl status dnsmasq
```

!!!
После настройки клиенты, подключенные к сети, будут автоматически получать IP-адреса через `dnsmasq`.
!!!

### Дигностика сети

```bash
ping -c 4 google.com # Проверка сетевого подключения
traceroute google.com # Определение маршрута к серверу
ss -tulnp # Активные порты и процессы
tcpdump -i eth0 port 80 # Просмотр трафика по протоколу TCP
```

## Файрволлы

### IPTABLES

**iptables** - классический брандмауэр Linux для фильтрации пакетов.

Основные цепочки в iptables:

1. **INPUT** - входящие пакеты.
2. **FORWARD** - пересылаемые пакеты.
3. **OUTPUT** - исходящие пакеты.

```bash
iptables -A INPUT -p tcp --dport 80 -j ACCEPT # Открытие порта 80 для входящих пакетов
iptables -P INPUT DROP # Запрет входящих пакетов
iptables -L -v -n # Просмотр таблицы правил
```

### NFTABLES

```bash
nft add table inet my_firewall # Создание таблицы правил
nft add chain inet my_firewall input { type filter hook input priority 0 \; } # Создание входящей цепочки
nft add rule inet my_firewall input tcp dport 80 accept # Добавление правила
nft list ruleset # Просмотр списка правил
nft list ruleset > /etc/nftables.conf # Сохранение настроек в файл
```
